generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  USER
  ADMIN
  DELIVERY_AGENT
}

model User {
  id        String   @id // Supabase Auth ID
  email     String   @unique
  name      String?
  phone     String?  // Main contact number (crucial for agents)
  role      Role     @default(USER)
  
  // Delivery Agent specific fields
  vehicleDetails String? // e.g., "Bike - MH12 AB 1234"
  isAvailable    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders         Order[]  @relation("CustomerOrders") // Rename implicit relation for clarity if needed, or keep default
  assignedOrders Order[]  @relation("DeliveryAgentOrders") // Orders assigned to this agent
  cart         Cart?
  wishlist     Wishlist?
  addresses    Address[]
  reviews      Review[]
  couponUsages CouponUsage[]
}

model Address {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  street    String
  city      String
  state     String
  zip       String
  country   String   @default("India")
  phone     String?
  tag       String   @default("Home") // e.g. Home, Work, Other
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Product {
  id             String    @id @default(uuid())
  name           String
  description    String
  price          Decimal   @db.Decimal(10, 2)
  salePercentage Int       @default(0) // 0-100 percentage off
  isOnSale       Boolean   @default(false)
  saleEndDate    DateTime? // Auto-remove sale after this date
  images         String[]
  stock          Int       @default(0)
  sku            String?   @unique
  volume         String?   // e.g. "100ml"
  concentration  String?   // e.g. "Parfum"
  isFeatured     Boolean   @default(false)
  isArchived     Boolean   @default(false)
  gender         Gender    @default(UNISEX)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  categoryId    String?
  category      Category?     @relation(fields: [categoryId], references: [id])
  orderItems    OrderItem[]
  cartItems     CartItem[]
  wishlistItems WishlistItem[]
  reviews       Review[]
}

enum Gender {
  MEN
  WOMEN
  UNISEX
}

model Category {
  id       String    @id @default(uuid())
  name     String    @unique
  image    String?
  products Product[]
}

model Cart {
  id        String     @id @default(uuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id        String  @id @default(uuid())
  cartId    String
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int
}

model Wishlist {
  id        String         @id @default(uuid())
  userId    String         @unique
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     WishlistItem[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}

model WishlistItem {
  id         String   @id @default(uuid())
  wishlistId String
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([wishlistId, productId])
}

model Order {
  id              String      @id @default(uuid())
  userId          String
  user            User        @relation("CustomerOrders", fields: [userId], references: [id])
  status          String      @default("PENDING") // PENDING, PROCESSING, OUT_FOR_DELIVERY, DELIVERED, CANCELLED
  subtotal        Decimal     @db.Decimal(10, 2) @default(0) // Amount before discount
  discount        Decimal     @db.Decimal(10, 2) @default(0) // Discount amount
  total           Decimal     @db.Decimal(10, 2)
  couponCode      String?     // Applied coupon code
  deliveryAddress Json?       // Stored address snapshot
  trackingNumber  String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  items           OrderItem[]

  // Delivery Agent Fields
  deliveryAgentId String?
  deliveryAgent   User?   @relation("DeliveryAgentOrders", fields: [deliveryAgentId], references: [id])
  deliveryOtp     String? // OTP for secure delivery verification
  agentCommission Decimal @default(0) @db.Decimal(10, 2)
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  price     Decimal @db.Decimal(10, 2)
}

model Review {
  id            String   @id @default(uuid())
  rating        Int
  comment       String?
  adminResponse String?  // Admin's single response
  respondedAt   DateTime?
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId     String
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
}

model Otp {
  id        String   @id @default(uuid())
  email     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Coupon {
  id              String        @id @default(uuid())
  code            String        @unique
  discountType    String        // 'PERCENTAGE' or 'FIXED'
  discountValue   Decimal       @db.Decimal(10, 2)
  minOrderValue   Decimal?      @db.Decimal(10, 2) // Minimum order value to apply
  maxUses         Int?          // Maximum number of times this coupon can be used
  usedCount       Int           @default(0)
  firstOrderOnly  Boolean       @default(false) // Only for users with no previous orders
  excludeSaleItems Boolean      @default(true)  // Cannot apply to products on sale
  expiresAt       DateTime?
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  usages          CouponUsage[] // Track who used this coupon
}

model CouponUsage {
  id        String   @id @default(uuid())
  couponId  String
  coupon    Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderId   String   // Which order used this coupon
  usedAt    DateTime @default(now())

  @@unique([couponId, userId]) // One coupon per user
  @@index([userId])
  @@index([couponId])
}
